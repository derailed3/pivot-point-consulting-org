name: Stale Content Scan

on:
  schedule:
    - cron: "0 9 1 * *"
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Find Stale Documents
        id: stale
        run: |
          echo "Scanning for documents past their review date..."
          today=$(date +%Y-%m-%d)
          stale_files=""
          count=0
          while IFS= read -r file; do
            if [[ "$file" == *"README.md" ]] || [[ "$file" == *"_archive"* ]]; then continue; fi
            review_date=$(grep -oP 'next-review:\s*"?\K[0-9]{4}-[0-9]{2}-[0-9]{2}' "$file" 2>/dev/null || echo "")
            if [ -n "$review_date" ] && [[ "$review_date" < "$today" ]]; then
              stale_files="$stale_files\n- \`$file\` (review due: $review_date)"
              count=$((count + 1))
            fi
          done < <(find . -name "*.md" -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./site/*")
          echo "stale_count=$count" >> $GITHUB_OUTPUT
          echo -e "$stale_files" > stale_files.txt

      - name: Create Issue for Stale Content
        if: steps.stale.outputs.stale_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const staleFiles = fs.readFileSync('stale_files.txt', 'utf8');
            const count = '${{ steps.stale.outputs.stale_count }}';
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Stale Content] ${count} document(s) past review date`,
              body: `## Stale Content Report\n\nThe following documents are past their \`next-review\` date and need to be reviewed and updated:\n\n${staleFiles}\n\n### Action Required\n\n1. Review each document for accuracy\n2. Update content as needed\n3. Update the \`next-review\` date in frontmatter\n4. Change \`status\` from \`stale\` back to \`approved\` after review\n\nGenerated by the monthly stale content scan.`,
              labels: ['stale-content']
            });
